<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Lua知识点总结 | Dand</title>
<meta name=keywords content="Lua"><meta name=description content="Lua知识点总结"><meta name=author content="Dand"><link rel=canonical href=https://dandkong.github.io/posts/lua%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://dandkong.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://dandkong.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://dandkong.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://dandkong.github.io/apple-touch-icon.png><link rel=mask-icon href=https://dandkong.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://dandkong.github.io/posts/lua%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Lua知识点总结"><meta property="og:description" content="Lua知识点总结"><meta property="og:type" content="article"><meta property="og:url" content="https://dandkong.github.io/posts/lua%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93/"><meta property="og:image" content="https://dandkong.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-04-11T21:40:59+08:00"><meta property="article:modified_time" content="2023-07-11T21:40:59+08:00"><meta property="og:site_name" content="Dand's Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://dandkong.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Lua知识点总结"><meta name=twitter:description content="Lua知识点总结"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://dandkong.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Lua知识点总结","item":"https://dandkong.github.io/posts/lua%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Lua知识点总结","name":"Lua知识点总结","description":"Lua知识点总结","keywords":["Lua"],"articleBody":"Lua知识点总结 1. 元表和元方法 __index元方法\n\u003e other = { foo = 3 } \u003e t = setmetatable({}, { __index = other }) \u003e t.foo 3 \u003e t.bar nil mytable = setmetatable({key1 = \"value1\"}, { __index = function(mytable, key) if key == \"key2\" then return \"metatablevalue\" else return nil end end }) __nexindex方法\n--没有的减赋值到元表中 mymetatable = {} mytable = setmetatable({key1 = \"value1\"}, { __newindex = mymetatable }) print(mytable.key1) mytable.newkey = \"新值2\" print(mytable.newkey,mymetatable.newkey) mytable.key1 = \"新值1\" print(mytable.key1,mymetatable.key1) mytable = setmetatable({key1 = \"value1\"}, { __newindex = function(mytable, key, value) rawset(mytable, key, \"\\\\\"\"..value..\"\\\\\"\") --如果这里写成mytable[key]=value，会递归了 end }) mytable.key1 = \"new value\" mytable.key2 = 4 print(mytable.key1,mytable.key2) rawget和rawset\nraw方法就是忽略table对应的metatable，绕过metatable的行为约束，强制对原始表进行一次原始的操作，也就是一次不考虑元表的简单更新。\n2. lua面向对象实现 使用元表，__index父类，并在new方法返回一个新的table\nfunction class(classname, super) local superType = type(super) local cls -- inherited from Lua Object if super then cls = {} setmetatable(cls, {__index = super}) cls.super = super else cls = {ctor = function() end} end cls.__cname = classname cls.__ctype = 2 -- lua cls.__index = cls function cls.new(...) local instance = setmetatable({}, cls) instance.class = cls instance:ctor(...) return instance end return cls end 3. Table实现原理 数组和哈希的混合结构 4. 游戏常用方案 XLua ， ToLua ， ULua都只是提供了 C# 与 Lua 的互相调用机制，差别基本就是少量的语法差别。座位C#和lua的中间层，把C#生成Wrap代码，经过xlua调用Lua代码。\nLua调用C# Lua-C dll- C# Wrap-C# 通过ObjectTranslator获取C#中的实例 Wrap方式：非反射机制，需要为源文件生成相应的wrap文件，当启动Lua虚拟机时，Wrap文件将会被自动注册到Lua虚拟机中，之后，Lua文件将能够识别和调用C#源文件 总结：Lua调用Wrap文件， Wrap文件调用C#源文件 参考 【ToLua】C#和Lua的交互细节\n【Unity游戏开发】tolua之wrap文件的原理与使用 - 马三小伙儿 - 博客园\n5. LuaGC 原理 标记，清除 三色标记 参考 Lua GC机制分析与理解-上\n6.弱表 概括 • weak表中的引用是弱引用(weakreference)，弱引用不会导致对象的引用计数变化。换言之，如果一个对象只有弱引用指向它，那么gc会自动回收该对象的内存。\n示例 强表\nstrongTable = {} strongTable[1] = function() print(\"i am the first element\") end strongTable[2] = function() print(\"i am the second element\") end strongTable[3] = {10, 20, 30} print(table.getn(strongTable)) -- 3 collectgarbage() print(table.getn(strongTable)) -- 3 v模式\nweakTable = {} weakTable[1] = function() print(\"i am the first element\") end weakTable[2] = function() print(\"i am the second element\") end weakTable[3] = {10, 20, 30} setmetatable(weakTable, {__mode = \"v\"}) -- 设置为弱表 print(table.getn(weakTable)) --\u003e3 ele = weakTable[1] -- 给第一个元素增加一个引用 collectgarbage() print(table.getn(weakTable)) --\u003e1，第一个函数引用为1，不能gc ele = nil -- 释放引用 collectgarbage() print(table.getn(weakTable)) --\u003e0，没有其他引用了，全部gc k模式\nt = {}; -- 给t设置一个元表，增加__mode元方法，赋值为“k” setmetatable(t, {__mode = \"k\"}); -- 使用一个table作为t的key值 key1 = {name = \"key1\"}; t[key1] = 1; key1 = nil; -- 又使用一个table作为t的key值 key2 = {name = \"key2\"}; t[key2] = 1; key2 = nil; -- 强制进行一次垃圾收集 collectgarbage(); for key, value in pairs(t) do print(key.name .. \":\" .. value); end --输出 为空 应用 弱引用：当一个对象只被弱表引用时，如果该对象没有被其他对象引用，那么它会被垃圾回收。 缓存：当一个对象不被引用UI，可以从弱表被删除。 参考 [Lua]弱表Weak table_ouyangshima的博客-CSDN博客\n7. 参考 Lua知识点整理\n","wordCount":"357","inLanguage":"zh","image":"https://dandkong.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2023-04-11T21:40:59+08:00","dateModified":"2023-07-11T21:40:59+08:00","author":{"@type":"Person","name":"Dand"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://dandkong.github.io/posts/lua%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93/"},"publisher":{"@type":"Organization","name":"Dand","logo":{"@type":"ImageObject","url":"https://dandkong.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://dandkong.github.io/ accesskey=h title="Dand (Alt + H)"><img src=https://dandkong.github.io/images/avatar.png alt aria-label=logo height=35>Dand</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://dandkong.github.io/archives/ title=归档><span>归档</span></a></li><li><a href=https://dandkong.github.io/categories/ title=分类><span>分类</span></a></li><li><a href=https://dandkong.github.io/tags/ title=标签><span>标签</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://dandkong.github.io/>主页</a>&nbsp;»&nbsp;<a href=https://dandkong.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Lua知识点总结</h1><div class=post-description>Lua知识点总结</div><div class=post-meta><span title='2023-04-11 21:40:59 +0800 CST'>2023-4-11</span>&nbsp;·&nbsp;Dand</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#lua%e7%9f%a5%e8%af%86%e7%82%b9%e6%80%bb%e7%bb%93 aria-label=Lua知识点总结>Lua知识点总结</a><ul><li><a href=#1-%e5%85%83%e8%a1%a8%e5%92%8c%e5%85%83%e6%96%b9%e6%b3%95 aria-label="1. 元表和元方法">1. 元表和元方法</a></li><li><a href=#2-lua%e9%9d%a2%e5%90%91%e5%af%b9%e8%b1%a1%e5%ae%9e%e7%8e%b0 aria-label="2. lua面向对象实现">2. lua面向对象实现</a></li><li><a href=#3-table%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86 aria-label="3. Table实现原理">3. Table实现原理</a></li><li><a href=#4-%e6%b8%b8%e6%88%8f%e5%b8%b8%e7%94%a8%e6%96%b9%e6%a1%88 aria-label="4. 游戏常用方案">4. 游戏常用方案</a><ul><li><a href=#lua%e8%b0%83%e7%94%a8c aria-label=Lua调用C#>Lua调用C#</a></li><li><a href=#%e5%8f%82%e8%80%83 aria-label=参考>参考</a></li></ul></li><li><a href=#5-luagc aria-label="5. LuaGC">5. LuaGC</a><ul><li><a href=#%e5%8e%9f%e7%90%86 aria-label=原理>原理</a></li><li><a href=#%e5%8f%82%e8%80%83-1 aria-label=参考>参考</a></li></ul></li><li><a href=#6%e5%bc%b1%e8%a1%a8 aria-label=6.弱表>6.弱表</a><ul><li><a href=#%e6%a6%82%e6%8b%ac aria-label=概括>概括</a></li><li><a href=#%e7%a4%ba%e4%be%8b aria-label=示例>示例</a></li><li><a href=#%e5%ba%94%e7%94%a8 aria-label=应用>应用</a></li><li><a href=#%e5%8f%82%e8%80%83-2 aria-label=参考>参考</a></li></ul></li><li><a href=#7-%e5%8f%82%e8%80%83 aria-label="7. 参考">7. 参考</a></li></ul></li></ul></div></details></div><div class=post-content><h1 id=lua知识点总结>Lua知识点总结<a hidden class=anchor aria-hidden=true href=#lua知识点总结>#</a></h1><h2 id=1-元表和元方法>1. 元表和元方法<a hidden class=anchor aria-hidden=true href=#1-元表和元方法>#</a></h2><p><strong>__index元方法</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=p>&gt;</span> <span class=n>other</span> <span class=p>=</span> <span class=p>{</span> <span class=n>foo</span> <span class=p>=</span> <span class=m>3</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>&gt;</span> <span class=n>t</span> <span class=p>=</span> <span class=n>setmetatable</span><span class=p>({},</span> <span class=p>{</span> <span class=n>__index</span> <span class=p>=</span> <span class=n>other</span> <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>&gt;</span> <span class=n>t</span><span class=p>.</span><span class=n>foo</span>
</span></span><span class=line><span class=cl><span class=m>3</span>
</span></span><span class=line><span class=cl><span class=p>&gt;</span> <span class=n>t</span><span class=p>.</span><span class=n>bar</span>
</span></span><span class=line><span class=cl><span class=n>nil</span>
</span></span><span class=line><span class=cl><span class=n>mytable</span> <span class=p>=</span> <span class=n>setmetatable</span><span class=p>({</span><span class=n>key1</span> <span class=p>=</span> <span class=s>&#34;value1&#34;</span><span class=p>},</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>__index</span> <span class=p>=</span> <span class=n>function</span><span class=p>(</span><span class=n>mytable</span><span class=p>,</span> <span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>key</span> <span class=p>==</span> <span class=s>&#34;key2&#34;</span> <span class=n>then</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=s>&#34;metatablevalue&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>nil</span>
</span></span><span class=line><span class=cl>    <span class=n>end</span>
</span></span><span class=line><span class=cl>  <span class=n>end</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><p><strong>__nexindex方法</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=c1>--没有的减赋值到元表中</span>
</span></span><span class=line><span class=cl><span class=n>mymetatable</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=n>mytable</span> <span class=o>=</span> <span class=n>setmetatable</span><span class=p>({</span><span class=n>key1</span> <span class=o>=</span> <span class=s2>&#34;value1&#34;</span><span class=p>},</span> <span class=p>{</span> <span class=n>__newindex</span> <span class=o>=</span> <span class=n>mymetatable</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=n>mytable.key1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>mytable.newkey</span> <span class=o>=</span> <span class=s2>&#34;新值2&#34;</span>
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=n>mytable.newkey</span><span class=p>,</span><span class=n>mymetatable.newkey</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>mytable.key1</span> <span class=o>=</span> <span class=s2>&#34;新值1&#34;</span>
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=n>mytable.key1</span><span class=p>,</span><span class=n>mymetatable.key1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mytable</span> <span class=o>=</span> <span class=n>setmetatable</span><span class=p>({</span><span class=n>key1</span> <span class=o>=</span> <span class=s2>&#34;value1&#34;</span><span class=p>},</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>__newindex</span> <span class=o>=</span> <span class=kr>function</span><span class=p>(</span><span class=n>mytable</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>rawset</span><span class=p>(</span><span class=n>mytable</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=s2>&#34;</span><span class=se>\\</span><span class=s2>&#34;&#34;..value..&#34;</span><span class=err>\\</span><span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=c1>--如果这里写成mytable[key]=value，会递归了</span>
</span></span><span class=line><span class=cl>    <span class=kr>end</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>mytable.key1</span> <span class=o>=</span> <span class=s2>&#34;new value&#34;</span>
</span></span><span class=line><span class=cl><span class=n>mytable.key2</span> <span class=o>=</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=n>mytable.key1</span><span class=p>,</span><span class=n>mytable.key2</span><span class=p>)</span>
</span></span></code></pre></div><p><strong>rawget和rawset</strong></p><p>raw方法就是忽略table对应的metatable，绕过metatable的行为约束，强制对原始表进行一次原始的操作，也就是一次不考虑元表的简单更新。</p><h2 id=2-lua面向对象实现>2. lua面向对象实现<a hidden class=anchor aria-hidden=true href=#2-lua面向对象实现>#</a></h2><p>使用元表，__index父类，并在new方法返回一个新的table</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=kr>function</span> <span class=nf>class</span><span class=p>(</span><span class=n>classname</span><span class=p>,</span> <span class=n>super</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>local</span> <span class=n>superType</span> <span class=o>=</span> <span class=n>type</span><span class=p>(</span><span class=n>super</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>local</span> <span class=n>cls</span>
</span></span><span class=line><span class=cl>        <span class=c1>-- inherited from Lua Object</span>
</span></span><span class=line><span class=cl>     <span class=kr>if</span> <span class=n>super</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>            <span class=n>cls</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>            <span class=n>setmetatable</span><span class=p>(</span><span class=n>cls</span><span class=p>,</span> <span class=p>{</span><span class=n>__index</span> <span class=o>=</span> <span class=n>super</span><span class=p>})</span>
</span></span><span class=line><span class=cl>            <span class=n>cls.super</span> <span class=o>=</span> <span class=n>super</span>
</span></span><span class=line><span class=cl>        <span class=kr>else</span>
</span></span><span class=line><span class=cl>            <span class=n>cls</span> <span class=o>=</span> <span class=p>{</span><span class=n>ctor</span> <span class=o>=</span> <span class=kr>function</span><span class=p>()</span> <span class=kr>end</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>cls.__cname</span> <span class=o>=</span> <span class=n>classname</span>
</span></span><span class=line><span class=cl>        <span class=n>cls.__ctype</span> <span class=o>=</span> <span class=mi>2</span> <span class=c1>-- lua</span>
</span></span><span class=line><span class=cl>        <span class=n>cls.__index</span> <span class=o>=</span> <span class=n>cls</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kr>function</span> <span class=nc>cls</span><span class=p>.</span><span class=nf>new</span><span class=p>(...)</span>
</span></span><span class=line><span class=cl>            <span class=kd>local</span> <span class=n>instance</span> <span class=o>=</span> <span class=n>setmetatable</span><span class=p>({},</span> <span class=n>cls</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>instance.class</span> <span class=o>=</span> <span class=n>cls</span>
</span></span><span class=line><span class=cl>            <span class=n>instance</span><span class=p>:</span><span class=n>ctor</span><span class=p>(...)</span>
</span></span><span class=line><span class=cl>            <span class=kr>return</span> <span class=n>instance</span>
</span></span><span class=line><span class=cl>        <span class=kr>end</span>
</span></span><span class=line><span class=cl>    <span class=kr>return</span> <span class=n>cls</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span></code></pre></div><h2 id=3-table实现原理>3. Table实现原理<a hidden class=anchor aria-hidden=true href=#3-table实现原理>#</a></h2><ul><li>数组和哈希的混合结构</li></ul><h2 id=4-游戏常用方案>4. 游戏常用方案<a hidden class=anchor aria-hidden=true href=#4-游戏常用方案>#</a></h2><p>XLua ， ToLua ， ULua都只是提供了 C# 与 Lua 的互相调用机制，差别基本就是少量的语法差别。座位C#和lua的中间层，把C#生成Wrap代码，经过xlua调用Lua代码。</p><h3 id=lua调用c>Lua调用C#<a hidden class=anchor aria-hidden=true href=#lua调用c>#</a></h3><ul><li>Lua-C dll- C# Wrap-C#</li><li>通过ObjectTranslator获取C#中的实例</li><li>Wrap方式：非反射机制，需要为源文件生成相应的wrap文件，当启动Lua虚拟机时，Wrap文件将会被自动注册到Lua虚拟机中，之后，Lua文件将能够识别和调用C#源文件</li><li>总结：Lua调用Wrap文件， Wrap文件调用C#源文件</li></ul><h3 id=参考>参考<a hidden class=anchor aria-hidden=true href=#参考>#</a></h3><p><a href=https://zhuanlan.zhihu.com/p/109198841>【ToLua】C#和Lua的交互细节</a></p><p><a href=https://www.cnblogs.com/msxh/p/9813147.html>【Unity游戏开发】tolua之wrap文件的原理与使用 - 马三小伙儿 - 博客园</a></p><h2 id=5-luagc><strong>5. LuaGC</strong><a hidden class=anchor aria-hidden=true href=#5-luagc>#</a></h2><h3 id=原理><strong>原理</strong><a hidden class=anchor aria-hidden=true href=#原理>#</a></h3><ul><li>标记，清除</li><li>三色标记</li></ul><h3 id=参考-1><strong>参考</strong><a hidden class=anchor aria-hidden=true href=#参考-1>#</a></h3><p><a href="https://www.zhihu.com/tardis/zm/art/133939450?source_id=1003">Lua GC机制分析与理解-上</a></p><h2 id=6弱表>6.弱表<a hidden class=anchor aria-hidden=true href=#6弱表>#</a></h2><h3 id=概括>概括<a hidden class=anchor aria-hidden=true href=#概括>#</a></h3><p>• weak表中的引用是弱引用(weakreference)，弱引用不会导致对象的引用计数变化。换言之，如果一个对象只有弱引用指向它，那么gc会自动回收该对象的内存。</p><h3 id=示例>示例<a hidden class=anchor aria-hidden=true href=#示例>#</a></h3><p>强表</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=n>strongTable</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=n>strongTable</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=kr>function</span><span class=p>()</span> <span class=n>print</span><span class=p>(</span><span class=s2>&#34;i am the first element&#34;</span><span class=p>)</span> <span class=kr>end</span>
</span></span><span class=line><span class=cl><span class=n>strongTable</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=kr>function</span><span class=p>()</span> <span class=n>print</span><span class=p>(</span><span class=s2>&#34;i am the second element&#34;</span><span class=p>)</span> <span class=kr>end</span>
</span></span><span class=line><span class=cl><span class=n>strongTable</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>10</span><span class=p>,</span> <span class=mi>20</span><span class=p>,</span> <span class=mi>30</span><span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=n>table.getn</span><span class=p>(</span><span class=n>strongTable</span><span class=p>))</span>  <span class=c1>-- 3</span>
</span></span><span class=line><span class=cl><span class=n>collectgarbage</span><span class=p>()</span>                        
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=n>table.getn</span><span class=p>(</span><span class=n>strongTable</span><span class=p>))</span>  <span class=c1>-- 3</span>
</span></span></code></pre></div><p>v模式</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=n>weakTable</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=n>weakTable</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=kr>function</span><span class=p>()</span> <span class=n>print</span><span class=p>(</span><span class=s2>&#34;i am the first element&#34;</span><span class=p>)</span> <span class=kr>end</span>
</span></span><span class=line><span class=cl><span class=n>weakTable</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=kr>function</span><span class=p>()</span> <span class=n>print</span><span class=p>(</span><span class=s2>&#34;i am the second element&#34;</span><span class=p>)</span> <span class=kr>end</span>
</span></span><span class=line><span class=cl><span class=n>weakTable</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>10</span><span class=p>,</span> <span class=mi>20</span><span class=p>,</span> <span class=mi>30</span><span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=n>setmetatable</span><span class=p>(</span><span class=n>weakTable</span><span class=p>,</span> <span class=p>{</span><span class=n>__mode</span> <span class=o>=</span> <span class=s2>&#34;v&#34;</span><span class=p>})</span> <span class=c1>-- 设置为弱表</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=n>table.getn</span><span class=p>(</span><span class=n>weakTable</span><span class=p>))</span>      <span class=c1>--&gt;3</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=n>ele</span> <span class=o>=</span> <span class=n>weakTable</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>                <span class=c1>-- 给第一个元素增加一个引用</span>
</span></span><span class=line><span class=cl><span class=n>collectgarbage</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=n>table.getn</span><span class=p>(</span><span class=n>weakTable</span><span class=p>))</span>      <span class=c1>--&gt;1，第一个函数引用为1，不能gc</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=n>ele</span> <span class=o>=</span> <span class=kc>nil</span>                         <span class=c1>-- 释放引用</span>
</span></span><span class=line><span class=cl><span class=n>collectgarbage</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=n>table.getn</span><span class=p>(</span><span class=n>weakTable</span><span class=p>))</span>      <span class=c1>--&gt;0，没有其他引用了，全部gc</span>
</span></span></code></pre></div><p>k模式</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=n>t</span> <span class=o>=</span> <span class=p>{};</span>    
</span></span><span class=line><span class=cl><span class=c1>-- 给t设置一个元表，增加__mode元方法，赋值为“k”</span>
</span></span><span class=line><span class=cl><span class=n>setmetatable</span><span class=p>(</span><span class=n>t</span><span class=p>,</span> <span class=p>{</span><span class=n>__mode</span> <span class=o>=</span> <span class=s2>&#34;k&#34;</span><span class=p>});</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=c1>-- 使用一个table作为t的key值</span>
</span></span><span class=line><span class=cl><span class=n>key1</span> <span class=o>=</span> <span class=p>{</span><span class=n>name</span> <span class=o>=</span> <span class=s2>&#34;key1&#34;</span><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=n>t</span><span class=p>[</span><span class=n>key1</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>key1</span> <span class=o>=</span> <span class=kc>nil</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=c1>-- 又使用一个table作为t的key值</span>
</span></span><span class=line><span class=cl><span class=n>key2</span> <span class=o>=</span> <span class=p>{</span><span class=n>name</span> <span class=o>=</span> <span class=s2>&#34;key2&#34;</span><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=n>t</span><span class=p>[</span><span class=n>key2</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>key2</span> <span class=o>=</span> <span class=kc>nil</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=c1>-- 强制进行一次垃圾收集</span>
</span></span><span class=line><span class=cl><span class=n>collectgarbage</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=kr>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span> <span class=kr>in</span> <span class=n>pairs</span><span class=p>(</span><span class=n>t</span><span class=p>)</span> <span class=kr>do</span>
</span></span><span class=line><span class=cl>    <span class=n>print</span><span class=p>(</span><span class=n>key.name</span> <span class=o>..</span> <span class=s2>&#34;:&#34;</span> <span class=o>..</span> <span class=n>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl><span class=c1>--输出 为空</span>
</span></span></code></pre></div><h3 id=应用>应用<a hidden class=anchor aria-hidden=true href=#应用>#</a></h3><ul><li>弱引用：当一个对象只被弱表引用时，如果该对象没有被其他对象引用，那么它会被垃圾回收。</li><li>缓存：当一个对象不被引用UI，可以从弱表被删除。</li></ul><h3 id=参考-2>参考<a hidden class=anchor aria-hidden=true href=#参考-2>#</a></h3><p>[<a href="https://blog.csdn.net/shimazhuge/article/details/40310233?utm_source=pocket_saves">Lua]弱表Weak table_ouyangshima的博客-CSDN博客</a></p><h2 id=7-参考><strong>7. 参考</strong><a hidden class=anchor aria-hidden=true href=#7-参考>#</a></h2><p><a href=https://www.drflower.top/posts/43f53d35/>Lua知识点整理</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://dandkong.github.io/tags/lua/>Lua</a></li></ul><nav class=paginav><a class=prev href=https://dandkong.github.io/posts/%E7%8A%B6%E6%80%81%E5%90%8C%E6%AD%A5%E4%B8%8E%E5%B8%A7%E5%90%8C%E6%AD%A5/><span class=title>« 上一页</span><br><span>状态同步与帧同步</span>
</a><a class=next href=https://dandkong.github.io/posts/stl%E6%80%BB%E7%BB%93/><span class=title>下一页 »</span><br><span>STL总结</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://dandkong.github.io/>Dand</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>